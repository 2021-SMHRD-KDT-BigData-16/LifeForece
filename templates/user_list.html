<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Case list</title>
  <!--<script type="module" src="your-script.js"></script>-->
  <style>
    /* Tab content is initially hidden */
    .tab-content {
      display: none;
    }

    /* Style for active tab */
    .active {
      display: block;
    }
  </style>

  <!---->
  <script>
    var xhr;
    // 환자추가하기
    function postCase() {
      var patientId = document.getElementById("newcase").value;
      console.log(patientId)

      fetch("/cases1", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id: patientId }),
      })
        .then(response => response.json())
        .then(data => {
          console.log(data.result_msg)
          location.reload();
        })
        .catch(error => {
          console.error(error);
        });
    }

    //환자 검색하기
    function searchCase() {
      var pId = document.getElementById('p_id').value;
      console.log(pId)

      // Check if pId is valid
      if (pId.trim() !== "") {
        // Redirect to the user_search page with the p_id as a query parameter
        window.location.href = `/search_case?p_id=${pId}`;
        console.log(pId)
      } else {
        alert("환자 id를 확인하세요");
      }
    }

    // 환자 코멘트 수정하기
    function putCase(pId) {
      var comment = document.getElementById(`cmt_${pId}`).value;
      console.log(comment)

      fetch('/cases', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `p_id=${pId}&p_cmt=${encodeURIComponent(comment)}`,
      })
        .then(response => response.json())
        .then(data => {
          console.log(data.result_msg);
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }

    // 환자번호 입력시 삭제하기
    function delCase(pId) {

      if (confirm(`환자번호 ${pId}를 삭제하시겠습니까?`)) {
        fetch(`/cases?p_id=${pId}`, {
          method: 'DELETE',
        })
          .then(response => response.json())
          .then(data => {
            console.log(data.result_msg);
            location.reload();
          })
          .catch(error => {
            console.error('Error:', error);
          });
      }
    }


  </script>
  <!--탭 스크립트-->

  <script>
    function showTab(tabId) {
      var tabContent = document.getElementsByClassName("tab-content");
      for (var i = 0; i < tabContent.length; i++) {
        tabContent[i].style.display = "none";
      }

      document.getElementById(tabId).style.display = "block";
    }
  </script>


</head>

<body>

  <div style="padding:10px;">
    <a href="/">LOGOUT</a>
  </div>
  <!--환자 추가하기 // 검색하기 버튼-->

  <h4 style="padding:10px;">{{user}}님 로그인 하셨습니다.</h4>

  <div style="margin:20px 0">
    <input type="text" id="newcase" placeholder="환자아이디" />
    <button onclick="postCase()">추가하기</button>
  </div>
  <div style="margin: 20px 0">
    <input type="number" id="p_id" placeholder="P_ID">
    <button onclick="searchCase()">Search</button>
  </div>






  <button id="tabButton1" onclick="showTab('tabContent1')">all</button>
  <button id="tabButton2" onclick="showTab('tabContent2')">detected</button>


  <!--환자 테이블 나오는 곳-->
  <div id="tabContent1" class="tab-content" style="display: block;">
    <div id="casetable">
      <table width="100%" border="1" cellpadding="0" cellspacing="0">
        <tr>
          <th>환자아이디</th>
          <th>환자이름</th>
          <th>LF점수</th>
          <th>SOFA점수</th>
          <th>MEWS점수</th>
          <th>코멘트</th>
          <th>자세히보기</th>
          <th>삭제</th>
        </tr>

        {% if cases %}
        {% for case in cases %}
        <tr style="padding:10px;height:45px;" id="casebox_{{case.u_id}}">
          <td align="center" id="pid_{{case.p_id}}">{{ case.p_id }}</td>
          <td align="center">이름</td>
          <td align="center">{{case.p_score}}</td>
          <td align="center">{{case.p_SOFA}}</td>
          <td align="center">{{case.p_MEWS}}</td>
          <td align="center"><input type="text" id="cmt_{{case.p_id}}" value="{{case.p_cmt}}">
            <button onclick="putCase('{{case.p_id}}')">cmt</button>
          </td>
          <td align="center"><a href="/cases/{{case.p_id}}/?user_name={{user}}"><button>보기</button></a></td>
          <td align="center"><button onclick="delCase('{{case.p_id}}')">삭제</button></td>
        </tr>
        {% endfor %}
        {% else %}
        <tr style="padding:10px;border-top:solid 1px #3388cc;">
          <td>
            No case...
          </td>
        </tr>
        {% endif %}
      </table>
    </div>
  </div>

  <!--LF 점수 몇점(기본값: 60점) 이상만 나오게-->
  <div id="tabContent2" class="tab-content">
    <div id="casetable">
      <table width="100%" border="1" cellpadding="0" cellspacing="0">
        <tr>
          <th>환자아이디</th>
          <th>환자이름</th>
          <th>LF점수</th>
          <th>SOFA점수</th>
          <th>MEWS점수</th>
          <th>코멘트</th>
          <th>자세히보기</th>
          <th>삭제</th>
        </tr>

        {% if cases %}
        {% for case in cases %}
        {% if case.p_score >= 60 %}
        <tr style="padding:10px;height:45px;" id="casebox_{{case.u_id}}">
          <td align="center" id="pid_{{case.p_id}}">{{ case.p_id }}</td>
          <td align="center">이름</td>
          <td align="center">{{case.p_score}}</td>
          <td align="center">{{case.p_SOFA}}</td>
          <td align="center">{{case.p_MEWS}}</td>
          <td align="center"><input type="text" id="cmt_{{case.p_id}}" value="{{case.p_cmt}}">
            <button onclick="putCase('{{case.p_id}}')">cmt</button>
          </td>
          <td align="center"><a href="/cases/{{case.p_id}}"><button>보기</button></a></td>
          <td align="center"><button onclick="delCase('{{case.p_id}}')">삭제</button></td>
        </tr>
        {% endif %}
        {% endfor %}
        {% else %}
        <tr style="padding:10px;border-top:solid 1px #3388cc;">
          <td>
            등록된 환자가 없습니다.
          </td>
        </tr>
        {% endif %}
      </table>
    </div>
  </div>
<!--페이징 처리-->
  <div>
    <!-- Previous page link -->
    {% if page > 1 %}
    <a href="/cases?user={{user}}&page={{ page - 1 }}&rows_per_page={{ rows_per_page }}">Previous</a>
    {% endif %}

    <!-- Page numbers -->
    {% for p in range(1, total_pages + 1) %}
    {% if p == page %}
    <strong>{{ p }}</strong>
    {% else %}
    <a href="/cases?user={{user}}&page={{ p }}&rows_per_page={{ rows_per_page }}">{{ p }}</a>
    {% endif %}
    {% endfor %}

    <!-- Next page link -->
    {% if page < total_pages %} 
    <a href="/cases?user={{user}}&page={{ page + 1 }}&rows_per_page={{ rows_per_page }}">Next</a>
    {% endif %}
</div>

</body>

</html>